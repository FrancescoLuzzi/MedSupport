<!doctype html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ONNX Paraphrase Italian MPNet Test</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@latest/css/pico.min.css"
        />
    </head>
    <body>
        <main class="container">
            <h1>ONNX Paraphrase Italian MPNet Test</h1>

            <div class="input-section">
                <label>Modello:</label>
                <select id="modelSelect">
                    <option value="local">
                        Locale (paraphrase-italian-mpnet-med-v2)
                    </option>
                    <option value="xenova">
                        Xenova (paraphrase-multilingual-MiniLM-L12-v2)
                    </option>
                </select>

                <br /><br />

                <label for="inputText">Enter Italian text:</label>
                <textarea id="inputText">
acarbosio;uso orale;acarbosio tecnigen;50 mg compresse</textarea
                >

                <div class="example">
                    <p><strong>Esempi:</strong></p>
                    <p>
                        1. acarbosio;uso orale;acarbosio tecnigen;50 mg
                        compresse 40 compresse in blister pvc/pctfe/pvc/al
                    </p>
                    <p>2. acarbosio in compresse</p>
                    <p>3. acarbosio</p>
                </div>

                <button onclick="generateEmbedding()" id="btnEmbed">
                    Genera Embedding
                </button>
                <button onclick="compareExamples()" id="btnCompare">
                    Confronta Esempi
                </button>
                <span class="loading" id="loading">Caricamento...</span>
                <div class="progress" id="progress"></div>
            </div>

            <div class="results" id="results" style="display: none">
                <h2>Risultati</h2>
                <div id="vectorDisplay"></div>
                <div id="similarityDisplay"></div>
            </div>
        </main>

        <script>
            let worker = null;
            let workerReady = false;
            let currentRequestId = 0;
            let pendingCallbacks = new Map();

            const progressDiv = document.getElementById("progress");
            const loadingSpan = document.getElementById("loading");

            function showProgress(message) {
                progressDiv.textContent = message;
                progressDiv.style.display = "block";
            }

            function showLoading(message) {
                loadingSpan.textContent = message;
                loadingSpan.style.display = "inline";
            }

            async function initWorker() {
                if (worker) return;

                console.log("Initializing worker...");
                // worker = new Worker("onnx-worker.js", { type: "module" });
                worker = new Worker("onnx-worker.js", { type: "module" });

                worker.onerror = function (e) {
                    console.error("Worker error:", e);
                };

                // Wait for worker to be ready
                await new Promise((resolve) => {
                    worker.onmessage = function (e) {
                        if (e.data.type === "ready") {
                            resolve();
                        }
                    };
                });

                worker.onmessage = function (e) {
                    console.log("Message from worker:", e.data);
                    const {
                        type,
                        id,
                        success,
                        error,
                        embedding,
                        embeddings,
                        message,
                        model,
                    } = e.data;

                    if (type === "progress") {
                        showProgress(message);
                        return;
                    }

                    const callback = pendingCallbacks.get(id);
                    if (callback) {
                        pendingCallbacks.delete(id);
                        if (success) {
                            callback.resolve({ embedding, embeddings, model });
                        } else {
                            callback.reject(new Error(error));
                        }
                    }
                };
            }

            function sendToWorker(type, data) {
                console.log("Sending to worker:", type, data);
                return new Promise((resolve, reject) => {
                    const id = ++currentRequestId;
                    pendingCallbacks.set(id, { resolve, reject });
                    worker.postMessage({ type, id, data });
                });
            }

            async function generateEmbedding() {
                const useLocal =
                    document.getElementById("modelSelect").value === "local";
                const inputText = document
                    .getElementById("inputText")
                    .value.trim();

                if (!inputText) {
                    alert("Inserisci del testo!");
                    return;
                }

                document.getElementById("btnEmbed").disabled = true;
                showLoading(" Caricamento...");

                try {
                    if (useLocal) {
                        await initWorker();
                        showProgress(
                            "Caricamento modello e generazione embedding...",
                        );

                        const result = await sendToWorker(
                            "generate-embedding",
                            { text: inputText },
                        );
                        displayResults(
                            result.embedding,
                            inputText,
                            "paraphrase-italian-mpnet-med-v2 (768 dims)",
                        );
                    } else {
                        const { pipeline, env } = await import(
                            "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"
                        );
                        env.allowLocalModels = false;
                        showProgress("Scaricamento modello...");

                        const extractor = await pipeline(
                            "feature-extraction",
                            "Xenova/paraphrase-multilingual-MiniLM-L12-v2",
                        );
                        showProgress("Generazione embedding...");

                        const output = await extractor(inputText, {
                            pooling: "mean",
                            normalize: true,
                        });
                        displayResults(
                            Array.from(output.data),
                            inputText,
                            "paraphrase-multilingual-MiniLM-L12-v2 (384 dims)",
                        );
                    }

                    progressDiv.style.display = "none";
                    loadingSpan.classList.add("success");
                    loadingSpan.textContent = " Fatto!";
                } catch (error) {
                    progressDiv.textContent = "Errore: " + error.message;
                    progressDiv.style.color = "red";
                }

                document.getElementById("btnEmbed").disabled = false;
            }

            async function compareExamples() {
                const useLocal =
                    document.getElementById("modelSelect").value === "local";

                const examples = [
                    [
                        "acarbosio;uso orale;acarbosio tecnigen;50 mg compresse 40 compresse in blister pvc/pctfe/pvc/al",
                        "acarbosio;uso orale;acarbosio tecnigen;50 mg compresse 40 compresse in blister pvc/pctfe/pvc/al",
                    ],
                    [
                        "acarbosio;uso orale;acarbosio tecnigen;50 mg compresse 40 compresse in blister pvc/pctfe/pvc/al",
                        "acarbosio in compresse",
                    ],
                    [
                        "acarbosio;uso orale;acarbosio tecnigen;50 mg compresse 40 compresse in blister pvc/pctfe/pvc/al",
                        "acarbosio",
                    ],
                    [
                        "acarbosio;uso orale;acarbosio tecnigen;50 mg goccie 40 compresse in blister pvc/pctfe/pvc/al",
                        "acarbosio",
                    ],
                    [
                        "acarbosio;uso orale;acarbosio tecnigen;50 mg goccie 40 compresse in blister pvc/pctfe/pvc/al",
                        "acarbosio in compresse",
                    ],
                ];

                document.getElementById("btnCompare").disabled = true;
                showLoading(" Caricamento...");

                try {
                    if (useLocal) {
                        await initWorker();
                        showProgress("Caricamento modello...");

                        const result = await sendToWorker("compare-examples", {
                            examples,
                        });
                        displayComparison(result.embeddings);
                    } else {
                        const { pipeline, env } = await import(
                            "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"
                        );
                        env.allowLocalModels = false;
                        showProgress("Scaricamento modello...");

                        const extractor = await pipeline(
                            "feature-extraction",
                            "Xenova/paraphrase-multilingual-MiniLM-L12-v2",
                        );
                        showProgress("Generazione embedding...");

                        const embeddings = [];
                        for (const [text1, text2] of examples) {
                            const emb1 = await extractor(text1, {
                                pooling: "mean",
                                normalize: true,
                            });
                            const emb2 = await extractor(text2, {
                                pooling: "mean",
                                normalize: true,
                            });
                            embeddings.push({
                                emb1: Array.from(emb1.data),
                                emb2: Array.from(emb2.data),
                                text1,
                                text2,
                            });
                        }

                        displayComparison(embeddings);
                    }

                    progressDiv.style.display = "none";
                    loadingSpan.classList.add("success");
                    loadingSpan.textContent = " Fatto!";
                } catch (error) {
                    progressDiv.textContent = "Errore: " + error.message;
                    progressDiv.style.color = "red";
                }

                document.getElementById("btnCompare").disabled = false;
            }

            function displayComparison(embeddings) {
                let tableHTML =
                    "<h3>Confronto Similarità Cosine:</h3><table><tr><th>Testo 1</th><th>Testo 2</th><th>Similarità</th></tr>";

                for (const { emb1, emb2, text1, text2 } of embeddings) {
                    const similarity = cosineSimilarity(emb1, emb2);
                    tableHTML += `<tr><td>${text1.substring(0, 50)}...</td><td>${text2}</td><td class="similarity">${similarity.toFixed(4)}</td></tr>`;
                }

                tableHTML += "</table>";
                document.getElementById("vectorDisplay").innerHTML = tableHTML;
                document.getElementById("similarityDisplay").innerHTML = "";
                document.getElementById("results").style.display = "block";
            }

            function cosineSimilarity(a, b) {
                let dotProduct = 0,
                    normA = 0,
                    normB = 0;
                for (let i = 0; i < a.length; i++) {
                    dotProduct += a[i] * b[i];
                    normA += a[i] * a[i];
                    normB += b[i] * b[i];
                }
                return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
            }

            function displayResults(embeddingData, inputText, modelName) {
                document.getElementById("vectorDisplay").innerHTML = `
                <h3>Modello:</h3><p><strong>${modelName}</strong></p>
                <h3>Testo:</h3><p><strong>${inputText}</strong></p>
                <h3>Embedding (primi 10):</h3>
                <div class="vector-display">${embeddingData
                    .slice(0, 10)
                    .map((v) => v.toFixed(4))
                    .join(", ")}</div>
                <p><em>Dimensione: ${embeddingData.length}</em></p>
            `;
                document.getElementById("similarityDisplay").innerHTML = "";
                document.getElementById("results").style.display = "block";
            }
        </script>
    </body>
</html>
